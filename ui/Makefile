.PHONY: all
all: deps lint-check test build

###########
## Build ##
###########

.PHONY: deps
deps: package.json
	NODE_OPTIONS=--openssl-legacy-provider yarn install --frozen-lockfile

SOURCES := $(shell ls *.json) tailwind.config.js yarn.lock
SOURCES += $(shell find public)
SOURCES += $(shell find src -name '*.ts' -print)
SOURCES += $(shell find src -name '*.tsx' -print)
SOURCES += $(shell find src -name '*.js' -print)
SOURCES += $(shell find src -name '*.css' -print)

# builds a production app
.PHONY: build
build: deps $(SOURCES)
	@echo "+ $@"
	NODE_OPTIONS=--openssl-legacy-provider yarn build

# checks that files respect linting / formatting rules (primary used in CI)
.PHONY: lint-check
lint-check: deps $(SOURCES)
	@echo "+ $@"
	NODE_OPTIONS=--openssl-legacy-provider yarn lint-check

# runs unit tests in a non-interactive mode (w/o watching)
.PHONY: test
test: deps $(SOURCES)
	@echo "+ $@"
	NODE_OPTIONS=--openssl-legacy-provider yarn test --watchAll=false

#################
## Development ##
#################

# starts UI development server and opens browser window with UI
.PHONY: start
start-dev-server: deps
	@echo "+ $@"
	NODE_OPTIONS=--openssl-legacy-provider yarn start

# generates sources (e.g. API client). Right now it does depend on some resources generated by the
# root Makefile (e.g. Swagger definitions)
.PHONY: gen-src
gen-src:
	@echo "+ $@"
	NODE_OPTIONS=--openssl-legacy-provider yarn gen:src

# attempts to lint / format files where it's possible to do automatically (it'll change the files)
.PHONY: lint
lint: deps $(SOURCES)
	@echo "+ $@"
	NODE_OPTIONS=--openssl-legacy-provider yarn lint

# runs unit tests in an interactive watch mode
.PHONY: test-watch
test-watch: deps $(SOURCES)
	@echo "+ $@"
	NODE_OPTIONS=--openssl-legacy-provider yarn test

##########
## Misc ##
##########

# prints the list of files that this makefile considers as sources
.PHONY: printsrcs
printsrcs:
	@echo "+ $@"
	@echo "$(SOURCES)"
