# UI E2E Testing Against PR Cluster - Findings

## Summary

We successfully ran UI E2E tests against a PR cluster deployment and discovered that authentication **works** because PR clusters use `TEST_MODE=true`, which accepts JWTs signed with the hardcoded local-dev secret.

## Key Findings

### 1. Authentication Success ✅

**Initial Hypothesis:** Authentication would fail because:
- PR cluster uses `ENVIRONMENT=development` (not `LOCAL_DEPLOY=true`)
- Should be using real OIDC + GCP Secret Manager
- Cypress-generated JWTs with hardcoded secret should be rejected

**Actual Result:** Authentication **succeeded** because:
- PR cluster deployment uses `ENVIRONMENT=development TEST_MODE=true`
- `TEST_MODE=true` configures the backend to use the hardcoded session secret `local-dev-secret-min-32-chars-long`
- This is the same secret used by Cypress tests in `ui/cypress/support/commands.ts`
- JWTs generated by Cypress were accepted by the server

**Evidence:**
- Test "should load the page without authentication errors" **PASSED** ✓
- Test accessed `/v1/whoami` endpoint successfully
- No authentication errors in logs

### 2. Test Results

**Run Details:**
- Workflow: https://github.com/stackrox/infra/actions/runs/20830380243
- Job: ui-e2e-test-pr-cluster
- Duration: ~2 minutes for E2E tests

**Results:**
- ✅ **3 tests PASSED**
  - home.cy.ts: "should load the home page"
  - home.cy.ts: "should not show error messages"
  - flavor-selection.cy.ts: "should load the page without authentication errors"

- ❌ **4 tests FAILED** (all timeout issues, not auth failures)
  - flavor-selection.cy.ts: "should display a list of available flavors"
  - flavor-selection.cy.ts: "should display flavor details for each flavor card"
  - flavor-selection.cy.ts: "should have clickable flavor cards that navigate to launch page"
  - flavor-selection.cy.ts: "should toggle between flavor filter states"

**Failure Cause:**
All failures were due to timeouts waiting for the `h2` page heading element (10-second timeout was too short for remote environment with network latency).

### 3. Configuration Analysis

**Secrets Template Structure:**
```yaml
# chart/infra-server/templates/secrets.yaml

# Lines 0-116: When localDeploy=false
# Uses real OIDC config from GCP Secret Manager
oidc.yaml: {{ .Values.oidc_yaml | b64dec }}

# Lines 118+: When localDeploy=true
# Uses hardcoded session secret
oidc.yaml: |
  sessionSecret: local-dev-secret-min-32-chars-long
```

**PR Deployment Command:**
```bash
ENVIRONMENT=development TEST_MODE=true make helm-deploy
```

**Test Mode Behavior:**
When `TEST_MODE=true` is set, the deployment uses the hardcoded session secret, enabling Cypress tests to authenticate even against "development" environment.

## Solutions Applied

### 1. Increased Test Timeouts

Updated `ui/cypress/e2e/flavor-selection.cy.ts` to use 30-second timeouts instead of 10 seconds for all element lookups:

```typescript
cy.get(SELECTORS.PAGE_HEADING, { timeout: 30000 }).should('be.visible');
cy.get(SELECTORS.FLAVOR_CARD, { timeout: 30000 }).should('have.length.at.least', 1);
```

This accounts for:
- Network latency to remote cluster
- Slower page rendering in cloud environment
- Time for backend API calls to complete

### 2. Updated Documentation

Updated `ui/TESTING.md` to clarify:
- Tests work with `TEST_MODE=true` deployments (not just `LOCAL_DEPLOY=true`)
- PR clusters use `TEST_MODE=true`, so authentication works
- PR clusters may have different data/configuration, requiring longer timeouts

## Architectural Insights

### TEST_MODE vs LOCAL_DEPLOY

There are two related but different concepts:

1. **`LOCAL_DEPLOY=true`** (in `chart/infra-server/configuration/local-values.yaml`)
   - Sets `localDeploy: true` in Helm chart
   - Uses minimal configuration (no GCS, no BigQuery, etc.)
   - Uses hardcoded session secret
   - Used for local development (Colima, kind, etc.)

2. **`TEST_MODE=true`** (environment variable)
   - Sets `testMode: true` in Helm chart
   - Enables test-specific behavior (faster timeouts, etc.)
   - **Also uses hardcoded session secret** when set
   - Used in both local development AND PR clusters

**Key Discovery:** PR clusters use `TEST_MODE=true` which is why they accept the hardcoded session secret, even though they're deployed as `ENVIRONMENT=development`.

## Implications

### For PR Workflow

The current PR workflow configuration is **correct** for UI E2E testing:
- PR clusters are automatically configured with `TEST_MODE=true`
- No special configuration needed for UI tests to authenticate
- Tests can run against PR cluster deployments

### For Production

Production deployments should **NEVER** use `TEST_MODE=true`:
- Would accept JWTs signed with the hardcoded secret (security risk)
- Should only use real OIDC with secrets from GCP Secret Manager

### For Future Testing

The increased timeouts (30s) should handle:
- Local development (fast)
- PR cluster deployments (medium latency)
- Development environment (varies)

If tests still timeout, the issue is likely:
- Missing data/flavors in environment
- Backend errors preventing page load
- Network connectivity issues

## Next Steps

1. ✅ Commit timeout fixes (DONE)
2. ✅ Update documentation (DONE)
3. ⏳ Push changes and verify tests pass in next PR run
4. ⏳ Monitor test stability over multiple PR runs
5. ⏳ Consider adding more test scenarios for remote environments

## Commits

- `623f2e0` - Increase timeouts for flavor-selection tests
- `9759efa` - Document PR cluster testing findings in TESTING.md

## Conclusion

The UI E2E tests successfully work against PR cluster deployments because of the `TEST_MODE=true` configuration. The test failures were **not** due to authentication issues, but rather due to environment differences (slower network, different data) that required longer timeouts.

This finding validates that the PR workflow can include UI E2E tests without additional authentication configuration.
